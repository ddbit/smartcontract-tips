---
layout: post
title: Transazioni gasless per eliminare le barriere ai nuovi utenti Ethereum
date: 2022-07-24 14:10:52.000000000 +02:00

category: In-Depth

tags:
- Meta Transactions
- Gasless
- ERC-2612

related: true 
permalink: "/articoli/transazioni-gasless-per-facilitare-lonboarding-degli-utenti-ethereum/"
image: /featured_images/image-e1699635470183.png
---
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Una delle maggiori cause di frizione nell’adozione di app web3 da parte nuovi utenti e in particolare di utenti che non sono “nativamente” abituati all’uso di wallet Ethereum è sicuramente la complessità della procedura di onboarding.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul><!-- wp:list-item --></p>
<li>Atterrare sulla app</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Aprire il chrome store</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Installare l’estensione per il wallet (eg. Metamask)</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Accettare termini e condizioni</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Salvare in luogo sicuro le 12 parole del seed</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Re-inserirle a scopo di verifica</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Impostare una password sicura per cifrare il seed nel dispositivo</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Copiare il nuovo indirizzo generato</li>
<p><!-- /wp:list-item --></ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>E a questo punto abbiamo un wallet ed un account Ethereum pronto all’uso, ma <strong>non abbiamo ancora ether e quindi non possiamo interagire con nessuna dapp perché non potremmo pagare il gas</strong>. Quindi dobbiamo proseguire con le seguenti azioni</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul><!-- wp:list-item --></p>
<li>Cercare un exchange, ahime centralizzato visto che non abbiamo ancora ether</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Creare un account</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Scegliere la password sicura secondo le regole della piattaforma</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Accettare i termini e le condizioni dell’exchange</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Verificare la mail</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Inserire i propri dati anagrafici per il KYC</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Trasmettere bolletta o altro documento aggiornato per la prova di domicilio</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>(dall’entrata in vigore di MiCA e travel rule) Dimostrare di controllare l’indirizzo blockchain tramite satoshi test o equivalente</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Spedire un bonifico</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Attendere accredito delle somme in euro</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Comprare ether</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Fare un prelievo di ether verso l’indirizzo ethereum del punto sopra</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Iniziare a usare la dapp&nbsp;</li>
<p><!-- /wp:list-item --></ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Facilitare l’adozione da parte di nuovi utenti è probabilmente l’aspetto più importante del web3.<strong> L’esperienza utente sopra descritta è totalmente frustrante.</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 class="wp-block-heading">Trilemma dell'usabilità per app web3?</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Forse possiamo spingerci a fare una congettura che saremmo lieti di vedere smentita ovvero che una app Web3 può essere due di tre fra self-custodial (gestisci tu le tue chiavi), facile da usare e sicura. Si possono avere due di queste ma non tutt'e tre. Ripeto è una provocazione più che una congettura e dobbiamo lavorare per rimuoverla.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":5862,"sizeSlug":"full","linkDestination":"media"} --></p>
<figure class="wp-block-image size-full"><a href="https://smartcontract.tips/wp-content/uploads/2023/02/image.png" /><img src="{{ site.baseurl }}/assets/2022/07/image.png" alt="" class="wp-image-5862" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 class="wp-block-heading">Quali sono le soluzioni per non far pagare il gas ai nuovi utenti?</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Quali sono dunque le strategie possibili per mitigare questa frizione?</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Nel caso di app che richiedono l’uso di token erc20 possiamo sfruttare le fondamentali funzioni <strong>approve( )</strong> e <strong>transferFrom( )</strong>. Queste consentono di movimentare fondi “per conto” dell’utente senza che questo debba effettuare le transazioni. La app può farsi carico delle spese di gas e trovare un modo nel suo business model per assorbire queste fee.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Un flusso interessante potrebbe essere:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul><!-- wp:list-item --></p>
<li>Il f<strong>rontend della app genera per l’utente un mnemonic seed senza trasmetterlo al backend</strong>. Ne trasmette la chiave pubblica o indirizzo al server, mentre la chiave privata assolutamente resta al sicuro nel frontend.</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>La app chiede all’utente di salvare il seed e poi richiede una verifica dello stesso chiedendo all’utente di inserire le 12 parole</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>In background il server della <strong>app assegna qualche frazione di ether al nuovo account eth dell’utente</strong>&nbsp;</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Il frontend <strong>firma una transazione di approve( ) a beneficio del contratto della app o di una chiave controllata dalla app</strong>.</li>
<p><!-- /wp:list-item --></ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Da questo punto in poi<strong> la app può movimentare i fondi per conto dell’utente</strong>. Questa strategia consente di fare l’onboarding dell’utente e permettergli di movimentare token erc20 (ma anche nft erc721) senza che questi abbia praticamente mai a che fare con un wallet e con tutte le sue complicazioni. E’ fatto salva comunque la facoltà dell’utente di installarsi un wallet come Metamask e gestire i propri fondi direttamente.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Questa strategia è funzionale ma presenta una vulnerabilità, ovvero il backend della app deve rifocillare l’account appena creato all’utente in modo che la transazione di <strong>approve( )</strong> possa essere eseguita, quella che assegna alla app di spendere per conto dell’utente.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Per evitare che l’utente possa sfruttare questa vulnerabilità con un sybil attack che consumerebbe le riserve di ether del backend della app, il business model dovrebbe prevedere una fee in euro immediata per l’utente, una transazione con carta di credito o altro mezzo di pagamento ma si ricadrebbe in un'esperienza utente faticosa. Quasi nessuna applicazione oggi chiede un pagamento anticipato prima ancora di mostrare la sua utilità.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Quali sono dunque le best practice per mitigare questo problema?</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 class="wp-block-heading">Eip-2612 -- ERC-20 approvals via secp256k1 signatures</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Una soluzione valida e molto interessante è quella che consente di creare delle transazioni a partire da messaggi firmati dall’utente che però non agisce direttamente creando una vera transazione e firmandola come avviene di solito nelle dapp. Vediamo un po’ meglio questo processo.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Supponiamo di avere un contratto erc20 in cui l’utente <strong>Alice</strong> con chiave <strong>0xAaAa..aa</strong> ha un balance pari a 100 unità. Nel modo classico Alice potrebbe assegnare alla nostra app il potere di spesa, con una logica scritta in pseudo-codice</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>approve&nbsp; app , 100</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>In questo caso Alice deve creare una vera e propria transazione, firmarla, spedirla e quindi pagare il gas.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Se volessimo evitare ad Alice il pagamento del gas potremmo in realtà sviluppare nel nostro contratto ERC20 una funzione che riceve un messaggio firmato da Alice ma non una vera e propria transazione.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Potremmo invece pensare che Alice firmi un semplice messaggio con una logica del tipo</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong><em>“Permit the App to spend 100 tokens” ---signed Alice</em></strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>E poi questo messaggio potrebbe essere trasformato in una vera transazione, consegnata allo smart contract dalla App stessa che si farebbe carico delle fee di mining.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Ma Perché dovrebbe farlo?</strong> Semplicemente perché potrebbe essere un modo per ottenere l’onboarding di Alice nel sistema come nuovo cliente e lo sviluppatore della App potrebbe considerare questa come una spesa necessaria al pari di ogni altro costo associato al marketing.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Lo standard EIP è stato pensato proprio per rendere questo processo sicuro e riproducibile senza doverlo reinventare per ogni app. https://eips.ethereum.org/EIPS/eip-2612 </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Come abbiamo detto in precedenza, ERC20 contiene una logica molto potente e flessibile grazie al meccanismo di delega di spesa che permette ad un terzo di spendere per conto dell’utente tramite <strong>transferFrom</strong>( ), ma purtroppo per assegnare questa delega l’utente deve essere in grado di fare una transazione <strong>approve( ) </strong>presso il contratto ERC20 del token e quindi essere in grado di pagare il gas avendo già una scorta di ether.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Lo standard EIP2612 estende lo standard ERC-20 con una nuova funzione <strong>permit( )</strong>, che consente agli utenti di modificare la mappatura delle quote utilizzando un messaggio firmato, anziché tramite msg.sender.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>La specifica qui presentata è in linea con l'implementazione in <a href="https://github.com/uniswap/uniswap-v2-core">Uniswap-v2</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>La funzione <strong>permit( )</strong> è sufficiente per consentire a qualsiasi operazione che coinvolga i token ERC-20 di essere pagata utilizzando il token stesso, anziché l'ETH. <a rel="noreferrer noopener" href="https://github.com/dapphub/ds-dach" target="_blank">Un esempio di contratto che consente di effettuare transazioni con token senza gas è disponibile qui</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":1} --></p>
<h1 class="wp-block-heading">EIP-2771: Secure Protocol for Native Meta Transactions&nbsp;</h1>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Eip-2612 descritto nella sezione precedente è una soluzione pensata appositamente per la gestione di transazioni per token erc20 e questo è il suo limite di applicazione. Al contrario EIP 2771 è una soluzione architetturale più complessa e pensata per gestire in modo generalizzato<strong> un approccio gasless a qualsiasi tipo di transazione con smart contract</strong>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><img src="{{ site.baseurl }}/assets/2022/07/z8rXqRc2GXNDQRmjEXsBcRT2tbnUb1eJk5WEy-KHUXCe9wjtIt8TrKogvvrTkjnIqFxHeU_6EZcLklTPPzsjviEtPXnQvYYbotzUlaTO-Y0Pj0qDVQWmDywFBsesICTQdyibCJHgt1VXX_FwRVxfgQ" style="" /></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>(tratto da <a href="https://eips.ethereum.org/EIPS/eip-2771#motivation">https://eips.ethereum.org/EIPS/eip-2771</a>)&nbsp;</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Prevede la presenza dei seguenti attori:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul><!-- wp:list-item --></p>
<li>L’utente <strong>signer</strong> che firma la richiesta, in quanto non si tratta di una transazione completa ma di una sorta di surrogato che viaggia off chain.</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Il <strong>gas relay</strong>, che si occupa di validare la richiesta del signer ed è quello che sostanzialmente paga il gas</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Il <strong>forwarder</strong>, che è un’entità verificata e accettata dal contratto finale, quello che deve accettare la transazione</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Il <strong>recipient contract</strong>, che verifica che il forwarder sia nella sua whitelist e ha una speciale implementazione di msg.sender che permette al contratto di determinare chi è l’account signer che ha generato la richiesta originale, anche se in realtà quest’ultimo non sta interagendo direttamente con il contratto.</li>
<p><!-- /wp:list-item --></ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Per costruire un contratto recipient capace di eseguire queste meta-transazioni si può partire da questa base class</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><a href="https://github.com/opengsn/forwarder/blob/master/contracts/BaseRelayRecipient.sol">https://github.com/opengsn/forwarder/blob/master/contracts/BaseRelayRecipient.sol</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Se stai sviluppando un prodotto web3 e vuoi facilitare l'onboarding ai tuoi clienti contattami.</strong> </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:jetpack/contact-form {"subject":"[Digital Davide] Transazioni gasless per eliminare le barriere ai nuovi utenti Ethereum","to":"dcarboni@gmail.com"} --></p>
<div class="wp-block-jetpack-contact-form"><!-- wp:jetpack/field-name {"required":true,"requiredText":"(obbligatorio)"} /--></p>
<p><!-- wp:jetpack/field-email {"required":true,"requiredText":"(obbligatorio)"} /--></p>
<p><!-- wp:jetpack/field-textarea {"label":"","requiredText":"(obbligatorio)"} /--></p>
<p><!-- wp:jetpack/button {"element":"button","text":"Contattaci","lock":{"remove":true}} /--></div>
<p><!-- /wp:jetpack/contact-form --></p>
